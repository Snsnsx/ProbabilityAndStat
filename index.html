<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;800&family=Manrope:wght@400;500;600&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #161b26;
    --surface2: #1e2535;
    --accent: #4f8ef7;
    --accent2: #6ee7c7;
    --danger: #ff4d6d;
    --warn: #ffb347;
    --text: #e8eaf0;
    --muted: #7a839a;
    --border: rgba(255,255,255,0.07);
    --radius: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }

  body {
    font-family: 'Manrope', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-user-select: none;
    user-select: none;
  }

  /* background pattern */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 50% at 20% 10%, rgba(79,142,247,0.12) 0%, transparent 70%),
      radial-gradient(ellipse 50% 40% at 80% 80%, rgba(110,231,199,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 600px;
    margin: 0 auto;
    padding: 20px 16px 40px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* HEADER */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    gap: 12px;
  }

  .logo {
    font-family: 'Unbounded', sans-serif;
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 0.08em;
    color: var(--accent);
    text-transform: uppercase;
  }

  .timer-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 40px;
    padding: 8px 16px;
    font-family: 'Unbounded', sans-serif;
    font-size: 15px;
    font-weight: 600;
    transition: color 0.3s, border-color 0.3s;
  }
  .timer-box.warn { color: var(--warn); border-color: rgba(255,179,71,0.4); }
  .timer-box.danger { color: var(--danger); border-color: rgba(255,77,109,0.4); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

  .timer-icon { font-size: 16px; }

  /* SCREENS */
  .screen { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.4s ease; }
  .screen.active { display: flex; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:none} }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px 24px;
    margin-bottom: 16px;
  }

  /* LOGIN */
  .login-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 8px;
    line-height: 1.3;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .login-sub {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 28px;
    line-height: 1.6;
  }

  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    margin-bottom: 6px;
  }

  input[type="text"] {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 13px 16px;
    font-family: 'Manrope', sans-serif;
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 16px;
    -webkit-user-select: text;
    user-select: text;
  }
  input[type="text"]:focus { border-color: var(--accent); }

  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 15px;
    border-radius: 12px;
    font-family: 'Manrope', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: transform 0.15s, opacity 0.15s;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #3a6fd8);
    color: #fff;
  }
  .btn-primary:hover { opacity: 0.92; }
  .btn-success {
    background: linear-gradient(135deg, var(--accent2), #3ab89a);
    color: #0d0f14;
    margin-top: 8px;
  }

  /* TASK */
  .task-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .task-num {
    font-family: 'Unbounded', sans-serif;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent);
  }
  .task-progress {
    font-size: 12px;
    color: var(--muted);
  }

  .task-img-placeholder {
    width: 100%;
    min-height: 200px;
    background: var(--surface2);
    border: 2px dashed rgba(79,142,247,0.3);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: var(--muted);
    font-size: 13px;
    text-align: center;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  .task-img-placeholder img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    display: none;
  }
  .img-icon { font-size: 36px; opacity: 0.5; }
  .img-label { font-size: 11px; opacity: 0.7; margin-top: 4px; }

  .answer-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text);
  }

  .answer-row {
    display: flex;
    gap: 10px;
  }

  .answer-input {
    flex: 1;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 13px 16px;
    font-family: 'Manrope', sans-serif;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    -webkit-user-select: text;
    user-select: text;
  }
  .answer-input:focus { border-color: var(--accent2); }

  /* DOTS PROGRESS */
  .dots {
    display: flex;
    gap: 6px;
    justify-content: center;
    margin-bottom: 20px;
  }
  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    transition: all 0.3s;
  }
  .dot.done { background: var(--accent2); border-color: var(--accent2); }
  .dot.current { background: var(--accent); border-color: var(--accent); transform: scale(1.3); }

  /* RESULT */
  .score-circle {
    width: 120px; height: 120px;
    border-radius: 50%;
    margin: 0 auto 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Unbounded', sans-serif;
    position: relative;
  }
  .score-num {
    font-size: 36px;
    font-weight: 800;
    line-height: 1;
  }
  .score-max { font-size: 12px; color: var(--muted); }

  .grade-badge {
    display: inline-block;
    font-family: 'Unbounded', sans-serif;
    font-size: 48px;
    font-weight: 800;
    text-align: center;
    width: 100%;
    margin-bottom: 8px;
  }

  .result-name {
    text-align: center;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .result-sub {
    text-align: center;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 24px;
  }

  .answers-breakdown { width: 100%; }
  .breakdown-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }
  .breakdown-item:last-child { border-bottom: none; }
  .ans-correct { color: var(--accent2); font-weight: 700; }
  .ans-wrong { color: var(--danger); font-weight: 700; }

  /* BANNER */
  .banner-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .banner-overlay.show { display: flex; }

  .banner-card {
    background: var(--surface);
    border: 1.5px solid rgba(255,77,109,0.5);
    border-radius: 20px;
    padding: 32px 24px;
    max-width: 380px;
    width: 100%;
    text-align: center;
    animation: bounceIn 0.4s ease;
  }
  @keyframes bounceIn {
    0%{transform:scale(0.8);opacity:0}
    70%{transform:scale(1.05)}
    100%{transform:scale(1);opacity:1}
  }
  .banner-icon { font-size: 48px; margin-bottom: 16px; }
  .banner-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 18px;
    font-weight: 800;
    color: var(--danger);
    margin-bottom: 10px;
  }
  .banner-text { font-size: 14px; color: var(--muted); line-height: 1.6; margin-bottom: 20px; }
  .banner-count { font-size: 13px; color: var(--warn); font-weight: 600; margin-bottom: 16px; }

  /* CANCELLED */
  .cancelled-icon { font-size: 64px; text-align: center; margin-bottom: 16px; }
  .cancelled-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 20px;
    font-weight: 800;
    color: var(--danger);
    text-align: center;
    margin-bottom: 8px;
  }
  .cancelled-text { text-align: center; color: var(--muted); font-size: 14px; line-height: 1.6; }

  /* Nav hint */
  .nav-hint { font-size: 12px; color: var(--muted); text-align: center; margin-top: 12px; }

  /* Variant badge */
  .variant-badge {
    font-size: 11px;
    color: var(--muted);
    background: var(--surface2);
    border-radius: 20px;
    padding: 4px 10px;
    border: 1px solid var(--border);
  }

  @media (max-width: 400px) {
    .card { padding: 20px 16px; }
    .login-title { font-size: 18px; }
  }
</style>
</head>
<body>

<div class="wrapper">
  <!-- TOP BAR -->
  <div class="top-bar" id="topBar" style="display:none">
    <div class="logo">üìù –ö–æ–Ω—Ç—Ä–æ–ª—å</div>
    <div class="timer-box" id="timerBox">
      <span class="timer-icon">‚è±</span>
      <span id="timerDisplay">20:00</span>
    </div>
  </div>

  <!-- SCREEN: LOGIN -->
  <div class="screen active" id="screenLogin">
    <div class="card" style="margin-top:auto;margin-bottom:auto">
      <div class="login-title">–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</div>
      <div class="login-sub">–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. –£ —Ç–µ–±—è –±—É–¥–µ—Ç 20 –º–∏–Ω—É—Ç.</div>
      <label>–§–∞–º–∏–ª–∏—è</label>
      <input type="text" id="inputSurname" placeholder="–ò–≤–∞–Ω–æ–≤" autocomplete="off">
      <label>–ò–º—è</label>
      <input type="text" id="inputName" placeholder="–ò–≤–∞–Ω" autocomplete="off">
      <button class="btn btn-primary" onclick="startQuiz()">‚ñ∂ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
    </div>
  </div>

  <!-- SCREEN: TASK -->
  <div class="screen" id="screenTask">
    <div class="dots" id="dotsBar"></div>

    <div class="card">
      <div class="task-header">
        <span class="task-num" id="taskNum">–ó–∞–¥–∞–Ω–∏–µ 1</span>
        <span class="variant-badge" id="variantBadge">–í–∞—Ä–∏–∞–Ω—Ç ?</span>
      </div>

      <div class="task-img-placeholder" id="imgPlaceholder">
        <div class="img-icon">üñº</div>
        <div>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∑–∞–¥–∞–Ω–∏–µ–º</div>
        <div class="img-label" id="imgHint">–ó–∞–¥–∞–Ω–∏–µ 1 ‚Äî –í–∞—Ä–∏–∞–Ω—Ç ?</div>
        <!-- –í—Å—Ç–∞–≤—å—Ç–µ img —Ç–µ–≥–∏ –Ω–∏–∂–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è/–≤–∞—Ä–∏–∞–Ω—Ç–∞ -->
        <img id="taskImage" src="" alt="–ó–∞–¥–∞–Ω–∏–µ">
      </div>

      <div class="answer-label">–¢–≤–æ–π –æ—Ç–≤–µ—Ç:</div>
      <div class="answer-row">
        <input type="text" class="answer-input" id="answerInput" placeholder="–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç..." inputmode="decimal" autocomplete="off">
      </div>
    </div>

    <button class="btn btn-primary" id="nextBtn" onclick="nextTask()">–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Üí</button>
    <div class="nav-hint" id="navHint">–ó–∞–¥–∞–Ω–∏–µ 1 –∏–∑ 4</div>
  </div>

  <!-- SCREEN: RESULT -->
  <div class="screen" id="screenResult">
    <div class="card">
      <div class="result-name" id="resultName">–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</div>
      <div class="result-sub" id="resultVariant">–í–∞—Ä–∏–∞–Ω—Ç 1</div>
      <div class="grade-badge" id="gradeEmoji">‚≠ê</div>
      <div class="score-circle" id="scoreCircle">
        <span class="score-num" id="scoreNum">0</span>
        <span class="score-max">–∏–∑ 4</span>
      </div>
      <div class="answers-breakdown" id="answersBreakdown"></div>
    </div>
    <div class="nav-hint" style="margin-top:8px">–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—á–∏—Ç–µ–ª—é ‚úì</div>
  </div>

  <!-- SCREEN: CANCELLED -->
  <div class="screen" id="screenCancelled">
    <div class="card" style="margin-top:auto;margin-bottom:auto">
      <div class="cancelled-icon">üö´</div>
      <div class="cancelled-title">–†–∞–±–æ—Ç–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞</div>
      <div class="cancelled-text">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –±–æ–ª–µ–µ –¥–≤—É—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π (–ø–æ–∫–∏–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç). –†–∞–±–æ—Ç–∞ –Ω–µ –ø—Ä–∏–Ω—è—Ç–∞. –û–±—Ä–∞—Ç–∏—Å—å –∫ —É—á–∏—Ç–µ–ª—é.</div>
    </div>
  </div>
</div>

<!-- BANNER -->
<div class="banner-overlay" id="bannerOverlay">
  <div class="banner-card">
    <div class="banner-icon">‚ö†Ô∏è</div>
    <div class="banner-title">–ó–∞–º–µ—á–∞–Ω–∏–µ!</div>
    <div class="banner-text" id="bannerText">–¢—ã –ø–æ–∫–∏–Ω—É–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã. –≠—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.</div>
    <div class="banner-count" id="bannerCount">–ù–∞—Ä—É—à–µ–Ω–∏–µ 1 –∏–∑ 2</div>
    <button class="btn btn-primary" onclick="dismissBanner()">–ü–æ–Ω—è–ª, –ø—Ä–æ–¥–æ–ª–∂–∞—é</button>
  </div>
</div>

<script>
// =====================
// CONFIGURATION
// =====================
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyMxyj0L5_UWuAnzxOB--Vvh3zoxUWn_zZtWHj-9R72ByaEjxtrZN44183TIevBiHk/exec'; // REPLACE!

const CORRECT_ANSWERS = [
  [0.5, 0.45, 0.36, 0.65],   // Task 1: variants 1-4
  [2, 4, 6, 12],               // Task 2
  [10, 8, 12, 4],              // Task 3
  [10, 1, 2, 5]                // Task 4
];

// =====================
// STATE
// =====================
let studentName = '';
let variant = 0; // 0-3
let currentTask = 0;
let answers = ['', '', '', ''];
let violations = 0;
let timerInterval = null;
let secondsLeft = 20 * 60;
let quizActive = false;
let finished = false;

// =====================
// ANTI-CHEAT
// =====================

// Disable right-click
document.addEventListener('contextmenu', e => { if (quizActive) e.preventDefault(); });

// Disable text selection copy
document.addEventListener('copy', e => { if (quizActive) e.preventDefault(); });
document.addEventListener('cut', e => { if (quizActive) e.preventDefault(); });

// Disable common key combos
document.addEventListener('keydown', e => {
  if (!quizActive) return;
  const blocked = (
    (e.ctrlKey && ['c','C','u','U','s','S','p','P','a','A'].includes(e.key)) ||
    (e.metaKey && ['c','C','u','U','s','S','p','P','a','A'].includes(e.key)) ||
    e.key === 'F12' || e.key === 'PrintScreen'
  );
  if (blocked) {
    e.preventDefault();
    if (e.key === 'PrintScreen') handleViolation('–ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞.');
  }
});

// Screenshot attempt (PrintScreen) ‚Äî also capture via keyup
document.addEventListener('keyup', e => {
  if (!quizActive) return;
  if (e.key === 'PrintScreen') {
    handleViolation('–ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞.');
  }
});

// Page visibility (tab switch, app switch)
document.addEventListener('visibilitychange', () => {
  if (!quizActive || finished) return;
  if (document.hidden) {
    handleViolation('–¢—ã –ø–æ–∫–∏–Ω—É–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã. –≠—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.');
  }
});

// Blur event (alt-tab, window switch)
window.addEventListener('blur', () => {
  if (!quizActive || finished) return;
  handleViolation('–¢—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è —Å –≤–∫–ª–∞–¥–∫–∏ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã. –≠—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.');
});

// beforeunload
window.addEventListener('beforeunload', e => {
  if (quizActive && !finished) {
    e.preventDefault();
    e.returnValue = '–†–∞–±–æ—Ç–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
  }
});

function handleViolation(message) {
  if (!quizActive || finished) return;
  violations++;
  if (violations > 2) return; // already cancelled

  document.getElementById('bannerText').textContent = message;
  document.getElementById('bannerCount').textContent = `–ù–∞—Ä—É—à–µ–Ω–∏–µ ${violations} –∏–∑ 2`;
  document.getElementById('bannerOverlay').classList.add('show');

  if (violations >= 2) {
    document.getElementById('bannerCount').textContent = '‚õî –°–ª–µ–¥—É—é—â–µ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ = –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ';
  }
}

// Track if we hit 3 violations after dismissal
function dismissBanner() {
  document.getElementById('bannerOverlay').classList.remove('show');
  if (violations > 2) {
    cancelQuiz();
  }
}

// Realistically: cancel on 3rd violation
window.addEventListener('visibilitychange', () => {
  if (!quizActive || finished) return;
  if (document.hidden && violations > 2) {
    setTimeout(cancelQuiz, 300);
  }
});

function cancelQuiz() {
  quizActive = false;
  finished = true;
  clearInterval(timerInterval);
  showScreen('screenCancelled');
  document.getElementById('topBar').style.display = 'none';
}

// =====================
// TIMER
// =====================
function startTimer() {
  timerInterval = setInterval(() => {
    secondsLeft--;
    if (secondsLeft <= 0) {
      secondsLeft = 0;
      updateTimerDisplay();
      finishQuiz();
      return;
    }
    updateTimerDisplay();
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(secondsLeft / 60).toString().padStart(2,'0');
  const s = (secondsLeft % 60).toString().padStart(2,'0');
  document.getElementById('timerDisplay').textContent = `${m}:${s}`;
  const box = document.getElementById('timerBox');
  box.classList.remove('warn','danger');
  if (secondsLeft <= 60) box.classList.add('danger');
  else if (secondsLeft <= 300) box.classList.add('warn');
}

// =====================
// QUIZ FLOW
// =====================
function startQuiz() {
  const surname = document.getElementById('inputSurname').value.trim();
  const name = document.getElementById('inputName').value.trim();
  if (!surname || !name) {
    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è.');
    return;
  }
  studentName = surname + ' ' + name;
  variant = Math.floor(Math.random() * 4); // 0-3 ‚Üí variant 1-4

  document.getElementById('topBar').style.display = 'flex';
  quizActive = true;
  currentTask = 0;
  answers = ['', '', '', ''];

  showScreen('screenTask');
  renderTask();
  startTimer();
}

function renderTask() {
  document.getElementById('taskNum').textContent = `–ó–∞–¥–∞–Ω–∏–µ ${currentTask + 1}`;
  document.getElementById('variantBadge').textContent = `–í–∞—Ä–∏–∞–Ω—Ç ${variant + 1}`;
  document.getElementById('imgHint').textContent = `–ó–∞–¥–∞–Ω–∏–µ ${currentTask + 1} ‚Äî –í–∞—Ä–∏–∞–Ω—Ç ${variant + 1}`;
  document.getElementById('answerInput').value = answers[currentTask] || '';
  document.getElementById('navHint').textContent = `–ó–∞–¥–∞–Ω–∏–µ ${currentTask + 1} –∏–∑ 4`;
  document.getElementById('nextBtn').textContent = currentTask < 3 ? '–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Üí' : '‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É';

  // Dots
  const dots = document.getElementById('dotsBar');
  dots.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const d = document.createElement('div');
    d.className = 'dot' + (i < currentTask ? ' done' : i === currentTask ? ' current' : '');
    dots.appendChild(d);
  }

  // Image: try to load task image
  // Image files should be named: task{1-4}_v{1-4}.png (e.g. task1_v2.png)
  const img = document.getElementById('taskImage');
  const placeholder = document.getElementById('imgPlaceholder');
  const imgSrc = `task${currentTask+1}_v${variant+1}.png`;
  img.onload = () => { img.style.display = 'block'; placeholder.querySelector('.img-icon').style.display = 'none'; placeholder.querySelector('div:nth-child(2)').style.display = 'none'; };
  img.onerror = () => { img.style.display = 'none'; placeholder.querySelector('.img-icon').style.display = ''; placeholder.querySelector('div:nth-child(2)').style.display = ''; };
  img.src = imgSrc;
}

function nextTask() {
  answers[currentTask] = document.getElementById('answerInput').value.trim();
  if (!answers[currentTask]) {
    if (!confirm('–¢—ã –Ω–µ –≤–≤—ë–ª –æ—Ç–≤–µ—Ç. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ?')) return;
    answers[currentTask] = '';
  }
  if (currentTask < 3) {
    currentTask++;
    renderTask();
  } else {
    finishQuiz();
  }
}

function finishQuiz() {
  if (finished) return;
  finished = true;
  quizActive = false;
  clearInterval(timerInterval);
  document.getElementById('topBar').style.display = 'none';

  showResult();
  sendResults();
}

function showResult() {
  showScreen('screenResult');
  document.getElementById('resultName').textContent = studentName;
  document.getElementById('resultVariant').textContent = `–í–∞—Ä–∏–∞–Ω—Ç ${variant + 1}`;

  let score = 0;
  const breakdown = document.getElementById('answersBreakdown');
  breakdown.innerHTML = '';

  for (let i = 0; i < 4; i++) {
    const correct = CORRECT_ANSWERS[i][variant];
    const userVal = parseFloat(answers[i]);
    const isRight = Math.abs(userVal - correct) < 0.001;
    if (isRight) score++;

    const row = document.createElement('div');
    row.className = 'breakdown-item';
    row.innerHTML = `
      <span>–ó–∞–¥–∞–Ω–∏–µ ${i+1}</span>
      <span>–û—Ç–≤–µ—Ç: <b>${answers[i] || '‚Äî'}</b></span>
      <span class="${isRight ? 'ans-correct' : 'ans-wrong'}">${isRight ? '‚úì' : '‚úó ' + correct}</span>
    `;
    breakdown.appendChild(row);
  }

  document.getElementById('scoreNum').textContent = score;

  const grades = ['', '2', '3', '4', '5'];
  const emojis = ['', 'üòü', 'üòê', 'üôÇ', 'üåü'];
  const colors = ['', '#ff4d6d', '#ffb347', '#4f8ef7', '#6ee7c7'];
  const grade = score === 0 ? 1 : score;
  document.getElementById('gradeEmoji').textContent = emojis[grade] + ' ' + grades[grade];
  document.getElementById('scoreCircle').style.boxShadow = `0 0 0 4px ${colors[grade]}33`;
  document.getElementById('scoreNum').style.color = colors[grade];
}

function sendResults() {
  const data = {
    name: studentName,
    variant: variant + 1,
    answers: answers.join('; '),
    score: (() => {
      let s = 0;
      for (let i = 0; i < 4; i++) {
        if (Math.abs(parseFloat(answers[i]) - CORRECT_ANSWERS[i][variant]) < 0.001) s++;
      }
      return s;
    })(),
    violations,
    time: new Date().toLocaleString('ru-RU')
  };

  const params = new URLSearchParams(data);
  fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), { method: 'GET', mode: 'no-cors' })
    .catch(() => {});
}

// =====================
// SCREEN SWITCH
// =====================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
</script>

</body>
</html>
