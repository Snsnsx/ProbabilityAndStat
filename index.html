<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;800&family=Manrope:wght@400;500;600&display=swap');

  :root {
    --bg: #0d0f14;
    --surface: #161b26;
    --surface2: #1e2535;
    --accent: #4f8ef7;
    --accent2: #6ee7c7;
    --danger: #ff4d6d;
    --warn: #ffb347;
    --text: #e8eaf0;
    --muted: #7a839a;
    --border: rgba(255,255,255,0.07);
    --radius: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }

  body {
    font-family: 'Manrope', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 50% at 20% 10%, rgba(79,142,247,0.12) 0%, transparent 70%),
      radial-gradient(ellipse 50% 40% at 80% 80%, rgba(110,231,199,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 600px;
    margin: 0 auto;
    padding: 20px 16px 40px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    gap: 12px;
  }

  .logo {
    font-family: 'Unbounded', sans-serif;
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 0.08em;
    color: var(--accent);
    text-transform: uppercase;
  }

  .timer-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 40px;
    padding: 8px 16px;
    font-family: 'Unbounded', sans-serif;
    font-size: 15px;
    font-weight: 600;
    transition: color 0.3s, border-color 0.3s;
  }
  .timer-box.warn { color: var(--warn); border-color: rgba(255,179,71,0.4); }
  .timer-box.danger { color: var(--danger); border-color: rgba(255,77,109,0.4); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
  .timer-icon { font-size: 16px; }

  .screen { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.4s ease; }
  .screen.active { display: flex; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:none} }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px 24px;
    margin-bottom: 16px;
  }

  .login-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 8px;
    line-height: 1.3;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .login-sub {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 28px;
    line-height: 1.6;
  }

  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    margin-bottom: 6px;
  }

  input[type="text"] {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 13px 16px;
    font-family: 'Manrope', sans-serif;
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 16px;
    -webkit-user-select: text;
    user-select: text;
  }
  input[type="text"]:focus { border-color: var(--accent); }

  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 15px;
    border-radius: 12px;
    font-family: 'Manrope', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: transform 0.15s, opacity 0.15s;
  }
  .btn:active { transform: scale(0.97); }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #3a6fd8);
    color: #fff;
  }
  .btn-primary:hover { opacity: 0.92; }
  .btn-success {
    background: linear-gradient(135deg, var(--accent2), #3ab89a);
    color: #0d0f14;
    margin-top: 8px;
  }

  .task-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .task-num {
    font-family: 'Unbounded', sans-serif;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent);
  }

  .task-img-placeholder {
    width: 100%;
    min-height: 200px;
    background: var(--surface2);
    border: 2px dashed rgba(79,142,247,0.3);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: var(--muted);
    font-size: 13px;
    text-align: center;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  .task-img-placeholder img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    display: none;
    pointer-events: none;
    -webkit-user-drag: none;
    user-drag: none;
  }
  .img-icon { font-size: 36px; opacity: 0.5; }

  .answer-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text);
  }

  .answer-row { display: flex; gap: 10px; }

  .answer-input {
    flex: 1;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    padding: 13px 16px;
    font-family: 'Manrope', sans-serif;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    -webkit-user-select: text;
    user-select: text;
  }
  .answer-input:focus { border-color: var(--accent2); }

  .dots {
    display: flex;
    gap: 6px;
    justify-content: center;
    margin-bottom: 20px;
  }
  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    transition: all 0.3s;
  }
  .dot.done { background: var(--accent2); border-color: var(--accent2); }
  .dot.current { background: var(--accent); border-color: var(--accent); transform: scale(1.3); }

  /* RESULT - no scores shown */
  .result-icon { font-size: 64px; text-align: center; margin-bottom: 16px; }
  .result-name {
    text-align: center;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .result-sub {
    text-align: center;
    font-size: 14px;
    color: var(--muted);
    line-height: 1.6;
  }

  .cancelled-icon { font-size: 64px; text-align: center; margin-bottom: 16px; }
  .cancelled-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 20px;
    font-weight: 800;
    color: var(--danger);
    text-align: center;
    margin-bottom: 8px;
  }
  .cancelled-text { text-align: center; color: var(--muted); font-size: 14px; line-height: 1.6; }

  .nav-hint { font-size: 12px; color: var(--muted); text-align: center; margin-top: 12px; }

  .banner-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(10px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .banner-overlay.show { display: flex; }

  .banner-card {
    background: var(--surface);
    border: 1.5px solid rgba(255,77,109,0.5);
    border-radius: 20px;
    padding: 32px 24px;
    max-width: 380px;
    width: 100%;
    text-align: center;
    animation: bounceIn 0.4s ease;
  }
  @keyframes bounceIn {
    0%{transform:scale(0.8);opacity:0}
    70%{transform:scale(1.05)}
    100%{transform:scale(1);opacity:1}
  }
  .banner-icon { font-size: 48px; margin-bottom: 16px; }
  .banner-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 18px;
    font-weight: 800;
    color: var(--danger);
    margin-bottom: 10px;
  }
  .banner-text { font-size: 14px; color: var(--muted); line-height: 1.6; margin-bottom: 20px; }
  .banner-count { font-size: 13px; color: var(--warn); font-weight: 600; margin-bottom: 16px; }

  /* Devtools warning */
  #devtoolsWarning {
    display: none;
    position: fixed;
    inset: 0;
    background: #0d0f14;
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    padding: 40px;
  }
  #devtoolsWarning.show { display: flex; }
  #devtoolsWarning .dw-icon { font-size: 64px; margin-bottom: 20px; }
  #devtoolsWarning .dw-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 22px;
    font-weight: 800;
    color: var(--danger);
    margin-bottom: 12px;
  }
  #devtoolsWarning .dw-text { color: var(--muted); font-size: 14px; line-height: 1.7; }

  @media (max-width: 400px) {
    .card { padding: 20px 16px; }
    .login-title { font-size: 18px; }
  }
</style>
</head>
<body>

<!-- DevTools overlay -->
<div id="devtoolsWarning">
  <div class="dw-icon">üîí</div>
  <div class="dw-title">–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç</div>
  <div class="dw-text">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.<br>–ó–∞–∫—Ä–æ–π DevTools –∏ –æ–±—Ä–∞—Ç–∏—Å—å –∫ —É—á–∏—Ç–µ–ª—é.</div>
</div>

<div class="wrapper">
  <div class="top-bar" id="topBar" style="display:none">
    <div class="logo">üìù –ö–æ–Ω—Ç—Ä–æ–ª—å</div>
    <div class="timer-box" id="timerBox">
      <span class="timer-icon">‚è±</span>
      <span id="timerDisplay">20:00</span>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="screen active" id="screenLogin">
    <div class="card" style="margin-top:auto;margin-bottom:auto">
      <div class="login-title">–ü—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞</div>
      <div class="login-sub">–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. –£ —Ç–µ–±—è –±—É–¥–µ—Ç 20 –º–∏–Ω—É—Ç. –ù–µ –ø–æ–∫–∏–¥–∞–π —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã.</div>
      <label>–§–∞–º–∏–ª–∏—è</label>
      <input type="text" id="inputSurname" placeholder="–ò–≤–∞–Ω–æ–≤" autocomplete="off">
      <label>–ò–º—è</label>
      <input type="text" id="inputName" placeholder="–ò–≤–∞–Ω" autocomplete="off">
      <button class="btn btn-primary" onclick="startQuiz()">‚ñ∂ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
    </div>
  </div>

  <!-- TASK -->
  <div class="screen" id="screenTask">
    <div class="dots" id="dotsBar"></div>

    <div class="card">
      <div class="task-header">
        <span class="task-num" id="taskNum">–ó–∞–¥–∞–Ω–∏–µ 1</span>
        <!-- Variant intentionally hidden from student -->
      </div>

      <div class="task-img-placeholder" id="imgPlaceholder">
        <div class="img-icon" id="imgIcon">üñº</div>
        <div id="imgLabel">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∑–∞–¥–∞–Ω–∏–µ–º</div>
        <img id="taskImage" src="" alt="–ó–∞–¥–∞–Ω–∏–µ" draggable="false">
      </div>

      <div class="answer-label">–¢–≤–æ–π –æ—Ç–≤–µ—Ç:</div>
      <div class="answer-row">
        <input type="text" class="answer-input" id="answerInput" placeholder="–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç..." inputmode="decimal" autocomplete="off">
      </div>
    </div>

    <button class="btn btn-primary" id="nextBtn" onclick="nextTask()">–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Üí</button>
    <div class="nav-hint" id="navHint">–ó–∞–¥–∞–Ω–∏–µ 1 –∏–∑ 4</div>
  </div>

  <!-- RESULT - no grades, no correct answers shown -->
  <div class="screen" id="screenResult">
    <div class="card" style="margin-top:auto;margin-bottom:auto;text-align:center">
      <div class="result-icon">‚úÖ</div>
      <div class="result-name" id="resultName">–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</div>
      <div class="result-sub">
        –†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–¥–∞–Ω–∞.<br>
        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –æ–±—ä—è–≤–ª–µ–Ω—ã —É—á–∏—Ç–µ–ª–µ–º.<br><br>
        <span style="color:var(--muted);font-size:12px">–ú–æ–∂–µ—à—å –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</span>
      </div>
    </div>
  </div>

  <!-- CANCELLED -->
  <div class="screen" id="screenCancelled">
    <div class="card" style="margin-top:auto;margin-bottom:auto">
      <div class="cancelled-icon">üö´</div>
      <div class="cancelled-title">–†–∞–±–æ—Ç–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞</div>
      <div class="cancelled-text">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ. –†–∞–±–æ—Ç–∞ –Ω–µ –ø—Ä–∏–Ω—è—Ç–∞. –û–±—Ä–∞—Ç–∏—Å—å –∫ —É—á–∏—Ç–µ–ª—é.</div>
    </div>
  </div>
</div>

<!-- WARNING BANNER -->
<div class="banner-overlay" id="bannerOverlay">
  <div class="banner-card">
    <div class="banner-icon">‚ö†Ô∏è</div>
    <div class="banner-title">–ó–∞–º–µ—á–∞–Ω–∏–µ!</div>
    <div class="banner-text" id="bannerText">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.</div>
    <div class="banner-count" id="bannerCount">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ 1 –∏–∑ 2</div>
    <button class="btn btn-primary" onclick="dismissBanner()">–ü–æ–Ω—è–ª, –ø—Ä–æ–¥–æ–ª–∂–∞—é</button>
  </div>
</div>

<script>
// =====================
// CONFIGURATION
// =====================
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyMxyj0L5_UWuAnzxOB--Vvh3zoxUWn_zZtWHj-9R72ByaEjxtrZN44183TIevBiHk/exec';

// Correct answers indexed by task (0-3) then variant (0-3)
const CORRECT_ANSWERS = [
  [0.5,   0.3,    0.5,    0.5   ],
  [0.096, 0.75,   0.9409, 0.87  ],
  [9,     30.5,   3,      3750  ],
  [11,    -28,    18,     24    ]
];

// =====================
// STATE
// =====================
let studentName = '';
let variant = 0;
let currentTask = 0;
let answers = ['', '', '', ''];
let violations = 0;
let timerInterval = null;
let secondsLeft = 20 * 60;
let quizActive = false;
let finished = false;
let bannerActive = false;

// =====================
// ANTI-CHEAT: DevTools Detection
// =====================
let devtoolsOpen = false;

function checkDevTools() {
  const threshold = 160;
  const widthDiff = window.outerWidth - window.innerWidth;
  const heightDiff = window.outerHeight - window.innerHeight;
  const open = widthDiff > threshold || heightDiff > threshold;

  if (open && !devtoolsOpen) {
    devtoolsOpen = true;
    if (quizActive && !finished) {
      // Instant cancel on devtools open
      document.getElementById('devtoolsWarning').classList.add('show');
      setTimeout(cancelQuiz, 1200);
    }
  } else if (!open && devtoolsOpen) {
    devtoolsOpen = false;
  }
}

// Debugger trap - slows/detects devtools
function debuggerTrap() {
  if (!quizActive || finished) return;
  const start = performance.now();
  // eslint-disable-next-line no-debugger
  debugger;
  const elapsed = performance.now() - start;
  if (elapsed > 100) {
    // Debugger was paused ‚Äî devtools open
    if (!devtoolsOpen) {
      devtoolsOpen = true;
      document.getElementById('devtoolsWarning').classList.add('show');
      setTimeout(cancelQuiz, 1200);
    }
  }
}

setInterval(checkDevTools, 800);
setInterval(debuggerTrap, 3000);

// =====================
// ANTI-CHEAT: Disable interactions
// =====================

// Right-click
document.addEventListener('contextmenu', e => e.preventDefault());

// Drag
document.addEventListener('dragstart', e => e.preventDefault());
document.addEventListener('drag', e => e.preventDefault());

// Copy / Cut / Paste (from clipboard)
document.addEventListener('copy', e => { if (quizActive) e.preventDefault(); });
document.addEventListener('cut', e => { if (quizActive) e.preventDefault(); });

// Touch long-press (iOS callout disabled via CSS, but also JS)
document.addEventListener('touchstart', e => {
  if (quizActive && e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
    e.preventDefault();
  }
}, { passive: false });

// Key combos
document.addEventListener('keydown', e => {
  if (!quizActive) return;
  const key = e.key.toLowerCase();
  const ctrl = e.ctrlKey || e.metaKey;
  const blocked = (
    ctrl && ['c','u','s','p','a','j','i','k','l','f'].includes(key)
  ) || e.key === 'F12' || e.key === 'F5' || e.key === 'F10' || e.key === 'F11';

  if (blocked) {
    e.preventDefault();
    e.stopPropagation();
    if (e.key === 'PrintScreen') handleViolation('screenshot');
  }
});

// PrintScreen on keyup
document.addEventListener('keyup', e => {
  if (!quizActive || finished) return;
  if (e.key === 'PrintScreen') {
    handleViolation('screenshot');
  }
});

// =====================
// ANTI-CHEAT: Visibility / Focus
// =====================

// Use a lock mechanism to avoid duplicate triggers
let violationLock = false;

document.addEventListener('visibilitychange', () => {
  if (!quizActive || finished) return;
  if (document.hidden) {
    triggerViolation('–¢—ã –ø–æ–∫–∏–Ω—É–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã.');
  }
});

window.addEventListener('blur', () => {
  if (!quizActive || finished || bannerActive) return;
  // Only fire if focus truly left the browser window (not just moved to an input/button inside the page)
  setTimeout(() => {
    if (!quizActive || finished || bannerActive) return;
    // If focus is now inside the document ‚Äî it's just an internal element focus, not a tab switch
    if (document.hasFocus()) return;
    triggerViolation('–¢—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è —Å –≤–∫–ª–∞–¥–∫–∏ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã.');
  }, 300);
});

// Fullscreen exit detection (optional ‚Äî uncomment if you want to require fullscreen)
// document.addEventListener('fullscreenchange', () => { ... });

window.addEventListener('beforeunload', e => {
  if (quizActive && !finished) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// Detect iframe embedding (anti-framing)
if (window.self !== window.top) {
  document.body.innerHTML = '<div style="padding:40px;text-align:center;color:#ff4d6d;font-family:sans-serif"><h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2><p>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–∞.</p></div>';
}

function triggerViolation(message) {
  if (violationLock) return;
  violationLock = true;
  setTimeout(() => { violationLock = false; }, 1500);
  handleViolation(message);
}

function handleViolation(message) {
  if (!quizActive || finished) return;
  violations++;

  if (violations >= 3) {
    cancelQuiz();
    return;
  }

  bannerActive = true;
  const isLast = violations === 2;
  document.getElementById('bannerText').textContent =
    typeof message === 'string' ? message : '–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.';
  document.getElementById('bannerCount').textContent = isLast
    ? '‚õî –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ. –°–ª–µ–¥—É—é—â–µ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ = –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.'
    : `–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ${violations} –∏–∑ 2`;
  document.getElementById('bannerOverlay').classList.add('show');
}

function handleViolation(msg) {
  if (!quizActive || finished) return;
  violations++;

  if (violations >= 3) {
    cancelQuiz();
    return;
  }

  bannerActive = true;
  document.getElementById('bannerText').textContent =
    typeof msg === 'string' ? msg : '–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ.';
  document.getElementById('bannerCount').textContent = violations === 2
    ? '‚õî –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ! –°–ª–µ–¥—É—é—â–µ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∞–Ω–Ω—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É.'
    : `–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ${violations} –∏–∑ 2`;
  document.getElementById('bannerOverlay').classList.add('show');
}

function dismissBanner() {
  document.getElementById('bannerOverlay').classList.remove('show');
  bannerActive = false;
  if (violations >= 3) cancelQuiz();
}

function cancelQuiz() {
  if (finished) return;
  quizActive = false;
  finished = true;
  clearInterval(timerInterval);
  document.getElementById('devtoolsWarning').classList.remove('show');
  document.getElementById('bannerOverlay').classList.remove('show');
  document.getElementById('topBar').style.display = 'none';
  showScreen('screenCancelled');

  // Still send data with cancelled flag
  sendResults(true);
}

// =====================
// TIMER
// =====================
function startTimer() {
  timerInterval = setInterval(() => {
    secondsLeft--;
    if (secondsLeft <= 0) {
      secondsLeft = 0;
      updateTimerDisplay();
      finishQuiz();
      return;
    }
    updateTimerDisplay();
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(secondsLeft / 60).toString().padStart(2,'0');
  const s = (secondsLeft % 60).toString().padStart(2,'0');
  document.getElementById('timerDisplay').textContent = `${m}:${s}`;
  const box = document.getElementById('timerBox');
  box.classList.remove('warn','danger');
  if (secondsLeft <= 60) box.classList.add('danger');
  else if (secondsLeft <= 300) box.classList.add('warn');
}

// =====================
// QUIZ FLOW
// =====================
function startQuiz() {
  const surname = document.getElementById('inputSurname').value.trim();
  const name = document.getElementById('inputName').value.trim();
  if (!surname || !name) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è.'); return; }

  studentName = surname + ' ' + name;
  variant = Math.floor(Math.random() * 4); // hidden from student

  document.getElementById('topBar').style.display = 'flex';
  quizActive = true;
  currentTask = 0;
  answers = ['', '', '', ''];

  showScreen('screenTask');
  renderTask();
  startTimer();
}

function renderTask() {
  document.getElementById('taskNum').textContent = `–ó–∞–¥–∞–Ω–∏–µ ${currentTask + 1}`;
  document.getElementById('answerInput').value = answers[currentTask] || '';
  document.getElementById('navHint').textContent = `–ó–∞–¥–∞–Ω–∏–µ ${currentTask + 1} –∏–∑ 4`;
  document.getElementById('nextBtn').textContent = currentTask < 3 ? '–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Üí' : '‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É';

  // Dots
  const dots = document.getElementById('dotsBar');
  dots.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const d = document.createElement('div');
    d.className = 'dot' + (i < currentTask ? ' done' : i === currentTask ? ' current' : '');
    dots.appendChild(d);
  }

  // Image
  const img = document.getElementById('taskImage');
  const icon = document.getElementById('imgIcon');
  const lbl = document.getElementById('imgLabel');
  const imgSrc = `task${currentTask+1}_v${variant+1}.png`;

  img.onload = () => {
    img.style.display = 'block';
    icon.style.display = 'none';
    lbl.style.display = 'none';
  };
  img.onerror = () => {
    img.style.display = 'none';
    icon.style.display = '';
    lbl.style.display = '';
  };
  img.src = imgSrc;
}

function normalizeAnswer(val) {
  return val.trim().replace(',', '.');
}

function nextTask() {
  answers[currentTask] = normalizeAnswer(document.getElementById('answerInput').value);
  if (!answers[currentTask]) {
    if (!confirm('–¢—ã –Ω–µ –≤–≤—ë–ª –æ—Ç–≤–µ—Ç. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ?')) return;
  }
  if (currentTask < 3) {
    currentTask++;
    renderTask();
    document.getElementById('answerInput').focus();
  } else {
    finishQuiz();
  }
}

function finishQuiz() {
  if (finished) return;
  finished = true;
  quizActive = false;
  clearInterval(timerInterval);
  document.getElementById('topBar').style.display = 'none';

  document.getElementById('resultName').textContent = studentName;
  showScreen('screenResult');
  sendResults(false);
}

function sendResults(cancelled) {
  let score = 0;
  for (let i = 0; i < 4; i++) {
    const v = parseFloat(answers[i]);
    if (!isNaN(v) && Math.abs(v - CORRECT_ANSWERS[i][variant]) < 0.001) score++;
  }

  const data = {
    name: studentName,
    variant: variant + 1,  // teacher sees it, student doesn't
    answers: answers.join('; '),
    score: score,
    violations: violations,
    cancelled: cancelled ? '–î–ê' : '–Ω–µ—Ç',
    time: new Date().toLocaleString('ru-RU')
  };

  const params = new URLSearchParams(data);
  fetch(GOOGLE_SCRIPT_URL + '?' + params.toString(), { method: 'GET', mode: 'no-cors' }).catch(() => {});
}

// =====================
// SCREEN SWITCH
// =====================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// =====================
// Disable view-source shortcut at document level
// =====================
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && ['i','j','c'].includes(e.key.toLowerCase())) {
    e.preventDefault();
  }
}, true);
</script>
</body>
</html>
