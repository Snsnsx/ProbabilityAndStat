<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Проверочная работа — Статистика</title>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;800&family=Golos+Text:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f1a;
    --surface: #141728;
    --surface2: #1c2038;
    --border: #2a2f50;
    --accent: #5b8dee;
    --accent2: #f7c948;
    --accent3: #4ecdc4;
    --danger: #ff4c6a;
    --success: #4ecb71;
    --text: #e8eaf6;
    --muted: #7a7f9a;
    --radius: 14px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'Golos Text', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }

  /* ─── NOISE OVERLAY ─── */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 1000; opacity: .4;
  }

  /* ─── HEADER ─── */
  .header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(13,15,26,.92);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px;
    gap: 12px;
  }
  .header-title { font-family: 'Unbounded', sans-serif; font-size: .75rem; font-weight: 600; color: var(--accent); letter-spacing: .06em; text-transform: uppercase; }
  .student-name { font-size: .85rem; color: var(--muted); max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .timer {
    display: flex; align-items: center; gap: 8px;
    background: var(--surface2); border: 1px solid var(--border);
    padding: 6px 14px; border-radius: 50px;
    font-family: 'Unbounded', sans-serif; font-size: .9rem; font-weight: 600;
    color: var(--accent2);
    transition: color .3s, border-color .3s;
  }
  .timer.danger { color: var(--danger); border-color: var(--danger); animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
  .timer-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: blink 1s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  /* ─── SCREENS ─── */
  .screen { display: none; animation: fadeUp .4s ease; }
  .screen.active { display: block; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

  .container { max-width: 680px; margin: 0 auto; padding: 24px 16px 60px; }

  /* ─── INTRO ─── */
  .intro-hero {
    text-align: center; padding: 40px 0 32px;
  }
  .intro-badge {
    display: inline-block;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    color: #fff; font-family: 'Unbounded', sans-serif; font-size: .65rem; letter-spacing: .1em;
    text-transform: uppercase; padding: 5px 14px; border-radius: 50px; margin-bottom: 20px;
  }
  .intro-title { font-family: 'Unbounded', sans-serif; font-size: clamp(1.5rem,5vw,2.2rem); font-weight: 800; line-height: 1.2; margin-bottom: 12px; }
  .intro-title span { color: var(--accent2); }
  .intro-sub { color: var(--muted); font-size: .95rem; line-height: 1.6; }
  .info-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 28px 0; }
  .info-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 16px; text-align: center;
  }
  .info-card .ic-val { font-family: 'Unbounded', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--accent2); }
  .info-card .ic-lbl { font-size: .78rem; color: var(--muted); margin-top: 4px; }

  /* ─── FORM ─── */
  .field { margin-bottom: 16px; }
  label { display: block; font-size: .8rem; font-weight: 600; color: var(--muted); letter-spacing: .05em; text-transform: uppercase; margin-bottom: 8px; }
  input[type="text"] {
    width: 100%; background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); padding: 14px 16px;
    color: var(--text); font-family: 'Golos Text', sans-serif; font-size: 1rem;
    transition: border-color .2s;
    -webkit-user-select: text; user-select: text;
  }
  input[type="text"]:focus { outline: none; border-color: var(--accent); }
  input[type="text"]::placeholder { color: var(--muted); }

  /* ─── BUTTONS ─── */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    width: 100%; padding: 15px 24px; border-radius: var(--radius);
    font-family: 'Unbounded', sans-serif; font-size: .85rem; font-weight: 600;
    letter-spacing: .04em; cursor: pointer; border: none; transition: all .2s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #4a7de0; transform: translateY(-1px); }
  .btn-success { background: var(--success); color: #0d1a12; }
  .btn-success:hover { opacity: .9; }
  .btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }

  /* ─── TASK CARD ─── */
  .task-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 18px;
    overflow: hidden; margin-bottom: 20px;
  }
  .task-header {
    background: var(--surface2); border-bottom: 1px solid var(--border);
    padding: 16px 20px; display: flex; align-items: center; gap: 12px;
  }
  .task-num {
    width: 36px; height: 36px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    display: flex; align-items: center; justify-content: center;
    font-family: 'Unbounded', sans-serif; font-size: .85rem; font-weight: 700; color: #fff;
    flex-shrink: 0;
  }
  .task-title { font-family: 'Unbounded', sans-serif; font-size: .85rem; font-weight: 600; }
  .task-body { padding: 20px; }
  .task-desc { font-size: .9rem; color: var(--muted); line-height: 1.6; margin-bottom: 20px; }

  /* ─── CHART ─── */
  .chart-wrap { margin: 16px 0; background: var(--surface2); border-radius: 12px; padding: 16px; }
  canvas { width: 100% !important; }

  /* ─── DATA TABLE ─── */
  .data-table {
    width: 100%; border-collapse: collapse; font-size: .82rem; margin-bottom: 16px;
    border-radius: 10px; overflow: hidden;
  }
  .data-table th {
    background: var(--surface2); color: var(--muted); font-weight: 600; letter-spacing: .05em;
    text-transform: uppercase; font-size: .72rem; padding: 10px 14px; text-align: center;
  }
  .data-table td { padding: 9px 14px; text-align: center; border-top: 1px solid var(--border); }
  .data-table tr:hover td { background: rgba(91,141,238,.07); }

  /* ─── ANSWER FIELDS ─── */
  .answer-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
  .answer-field { }
  .answer-field label { margin-bottom: 6px; }
  .answer-field input[type="number"] {
    width: 100%; background: var(--surface2); border: 1.5px solid var(--border);
    border-radius: 10px; padding: 12px 14px;
    color: var(--text); font-family: 'Golos Text', sans-serif; font-size: 1rem;
    transition: border-color .2s; text-align: center;
    -webkit-user-select: text; user-select: text;
  }
  .answer-field input[type="number"]:focus { outline: none; border-color: var(--accent); }
  .answer-field input.correct { border-color: var(--success) !important; background: rgba(78,203,113,.08); }
  .answer-field input.wrong { border-color: var(--danger) !important; background: rgba(255,76,106,.08); }

  /* ─── TASK 2 SLIDERS ─── */
  .slider-section { margin-top: 16px; }
  .slider-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  .slider-label { font-size: .8rem; color: var(--muted); min-width: 90px; font-weight: 600; }
  input[type="range"] {
    flex: 1; -webkit-appearance: none; height: 6px;
    background: var(--border); border-radius: 3px; outline: none; cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
    background: var(--accent); cursor: pointer; transition: transform .15s;
    box-shadow: 0 0 0 4px rgba(91,141,238,.2);
  }
  input[type="range"]::-webkit-slider-thumb:active { transform: scale(1.3); }
  .slider-val {
    min-width: 36px; text-align: center;
    font-family: 'Unbounded', sans-serif; font-size: .8rem; color: var(--accent2);
  }
  .dist-chart-wrap { margin: 16px 0; background: var(--surface2); border-radius: 12px; padding: 16px; }

  /* ─── DATA DISPLAY ─── */
  .data-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
  .chip {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 5px 10px; font-size: .82rem; color: var(--text);
  }

  /* ─── SCORE / RESULTS ─── */
  .result-hero { text-align: center; padding: 32px 0 24px; }
  .score-circle {
    width: 120px; height: 120px; border-radius: 50%;
    border: 4px solid var(--accent); margin: 0 auto 16px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: radial-gradient(circle, rgba(91,141,238,.12), transparent);
  }
  .score-num { font-family: 'Unbounded', sans-serif; font-size: 2rem; font-weight: 800; color: var(--accent2); }
  .score-max { font-size: .75rem; color: var(--muted); }
  .result-table { width: 100%; border-collapse: collapse; font-size: .88rem; }
  .result-table td { padding: 10px 12px; border-top: 1px solid var(--border); }
  .result-table td:first-child { color: var(--muted); }
  .result-table td:last-child { text-align: right; font-weight: 600; }

  /* ─── BANNER ─── */
  .violation-banner {
    display: none; position: fixed; inset: 0; z-index: 9999;
    background: rgba(13,15,26,.97);
    align-items: center; justify-content: center; flex-direction: column;
    text-align: center; padding: 32px;
  }
  .violation-banner.show { display: flex; animation: fadeUp .3s ease; }
  .vb-icon { font-size: 4rem; margin-bottom: 16px; }
  .vb-title { font-family: 'Unbounded', sans-serif; font-size: 1.4rem; font-weight: 800; color: var(--danger); margin-bottom: 12px; }
  .vb-text { color: var(--muted); font-size: .95rem; line-height: 1.6; max-width: 360px; }
  .vb-close { margin-top: 24px; }

  /* ─── PROGRESS ─── */
  .progress-bar { height: 3px; background: var(--border); border-radius: 2px; margin-bottom: 20px; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent3)); border-radius: 2px; transition: width .3s; }

  /* ─── SECTION NAV ─── */
  .task-nav { display: flex; gap: 10px; margin-bottom: 20px; }
  .nav-tab {
    flex: 1; padding: 10px; border-radius: 10px; text-align: center;
    font-family: 'Unbounded', sans-serif; font-size: .72rem; font-weight: 600;
    border: 1.5px solid var(--border); background: var(--surface);
    color: var(--muted); cursor: pointer; transition: all .2s;
  }
  .nav-tab.active { border-color: var(--accent); color: var(--accent); background: rgba(91,141,238,.1); }
  .nav-tab.done { border-color: var(--success); color: var(--success); background: rgba(78,203,113,.08); }

  @media (max-width: 400px) {
    .answer-group { grid-template-columns: 1fr; }
    .info-cards { grid-template-columns: 1fr 1fr; }
    .intro-title { font-size: 1.3rem; }
  }
</style>
</head>
<body>

<!-- HEADER (hidden until test starts) -->
<header class="header" id="mainHeader" style="display:none">
  <div>
    <div class="header-title">Проверочная работа</div>
    <div class="student-name" id="headerName">—</div>
  </div>
  <div class="timer" id="timer">
    <span class="timer-dot"></span>
    <span id="timerVal">35:00</span>
  </div>
</header>

<!-- VIOLATION BANNER -->
<div class="violation-banner" id="violationBanner">
  <div class="vb-icon">⚠️</div>
  <div class="vb-title">Нарушение!</div>
  <div class="vb-text">Вы покинули страницу проверочной работы. Это нарушение зафиксировано и будет учтено при проверке. Возвращайтесь к выполнению заданий.</div>
  <button class="btn btn-primary vb-close" onclick="closeViolation()" style="max-width:220px">Вернуться к работе</button>
</div>

<!-- ═══════════════════════════════════ SCREEN: INTRO ═══════ -->
<div class="screen active" id="screenIntro">
  <div class="container">
    <div class="intro-hero">
      <div class="intro-badge">Статистика • 8 класс</div>
      <div class="intro-title">Проверочная<br><span>работа</span></div>
      <div class="intro-sub">Внимательно читайте условия заданий.<br>Удачи!</div>
    </div>
    <div class="info-cards">
      <div class="info-card">
        <div class="ic-val">35</div>
        <div class="ic-lbl">минут</div>
      </div>
      <div class="info-card">
        <div class="ic-val">2</div>
        <div class="ic-lbl">задания</div>
      </div>
    </div>
    <div class="field">
      <label for="inputSurname">Фамилия</label>
      <input type="text" id="inputSurname" placeholder="Иванов" autocomplete="off">
    </div>
    <div class="field">
      <label for="inputName">Имя</label>
      <input type="text" id="inputName" placeholder="Иван" autocomplete="off">
    </div>
    <button class="btn btn-primary" onclick="startTest()">Начать работу →</button>
  </div>
</div>

<!-- ═══════════════════════════════════ SCREEN: TEST ═══════ -->
<div class="screen" id="screenTest">
  <div class="container">
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="task-nav">
      <div class="nav-tab active" id="tab1" onclick="showTask(1)">Задание 1</div>
      <div class="nav-tab" id="tab2" onclick="showTask(2)">Задание 2</div>
    </div>

    <!-- TASK 1 -->
    <div id="task1block">
      <div class="task-card">
        <div class="task-header">
          <div class="task-num">1</div>
          <div class="task-title">Анализ диаграммы: среднее и медиана</div>
        </div>
        <div class="task-body">
          <div class="task-desc">Изучите столбчатую диаграмму и таблицу данных ниже. Вычислите среднее арифметическое и медиану набора данных и введите ответы.</div>
          <div class="chart-wrap"><canvas id="chart1"></canvas></div>
          <table class="data-table" id="dataTable1"></table>
          <div class="answer-group">
            <div class="answer-field">
              <label>Среднее арифметическое</label>
              <input type="number" id="ans1mean" placeholder="0.0" step="0.01">
            </div>
            <div class="answer-field">
              <label>Медиана</label>
              <input type="number" id="ans1med" placeholder="0.0" step="0.01">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TASK 2 -->
    <div id="task2block" style="display:none">
      <div class="task-card">
        <div class="task-header">
          <div class="task-num">2</div>
          <div class="task-title">Построение гистограммы распределения</div>
        </div>
        <div class="task-body">
          <div class="task-desc">Ниже представлен набор из 30 числовых значений. При помощи ползунков установите высоту каждого из 6 столбцов гистограммы так, чтобы она корректно отображала распределение данных по интервалам.</div>
          <div class="data-chips" id="dataChips2"></div>
          <div class="dist-chart-wrap"><canvas id="chart2"></canvas></div>
          <div class="slider-section" id="sliderSection"></div>
        </div>
      </div>
    </div>

    <button class="btn btn-success" onclick="submitTest()">Завершить и сдать работу ✓</button>
  </div>
</div>

<!-- ═══════════════════════════════════ SCREEN: RESULT ═══════ -->
<div class="screen" id="screenResult">
  <div class="container">
    <div class="result-hero">
      <div class="score-circle">
        <div class="score-num" id="scoreNum">—</div>
        <div class="score-max">из 4</div>
      </div>
      <div class="intro-title" style="font-size:1.4rem">Работа сдана!</div>
      <div class="intro-sub" style="margin-top:8px" id="resultMsg">—</div>
    </div>
    <div class="task-card">
      <div class="task-header"><div class="task-num" style="background:linear-gradient(135deg,var(--accent2),#e8a020)">★</div><div class="task-title">Детали</div></div>
      <div class="task-body">
        <table class="result-table" id="resultTable"></table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
// ═══ CONFIG ═══
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwNEUKy54FuAd8WOwpM_ZtH4HPoYQPxQJm1cRtPyIIpXpEGceKWW8W0ElvArmzGyvjmxQ/exec';
const TOTAL_SECONDS = 35 * 60;

// ═══ STATE ═══
let studentName = '';
let timerInterval = null;
let secondsLeft = TOTAL_SECONDS;
let testStartTime = null;
let violationCount = 0;
let chart1Instance = null;
let chart2Instance = null;

// task1 data
let t1x = [], t1y = [], t1mean = 0, t1median = 0;
// task2 data
let t2data = [], t2intervals = [], t2counts = [], t2sliderVals = [];

// ═══ DISABLE COPY / SCREENSHOT ═══
document.addEventListener('copy', e => e.preventDefault());
document.addEventListener('cut', e => e.preventDefault());
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  // block PrintScreen, Ctrl+P, Ctrl+S, F12
  if (e.key === 'PrintScreen') { e.preventDefault(); showViolation(); }
  if ((e.ctrlKey || e.metaKey) && ['p','s','a','c','x','u'].includes(e.key.toLowerCase())) e.preventDefault();
  if (e.key === 'F12') e.preventDefault();
});

// ═══ LEAVE PAGE DETECTION ═══
document.addEventListener('visibilitychange', () => {
  if (document.hidden && testActive()) triggerViolation();
});
window.addEventListener('blur', () => {
  if (testActive()) triggerViolation();
});
window.addEventListener('beforeunload', e => {
  if (testActive()) { e.preventDefault(); e.returnValue = ''; }
});

function testActive() {
  return document.getElementById('screenTest').classList.contains('active');
}
function triggerViolation() {
  violationCount++;
  showViolation();
}
function showViolation() {
  document.getElementById('violationBanner').classList.add('show');
}
function closeViolation() {
  document.getElementById('violationBanner').classList.remove('show');
}

// ═══ START TEST ═══
function startTest() {
  const s = document.getElementById('inputSurname').value.trim();
  const n = document.getElementById('inputName').value.trim();
  if (!s || !n) { alert('Пожалуйста, введите фамилию и имя.'); return; }
  studentName = s + ' ' + n;
  document.getElementById('headerName').textContent = studentName;
  document.getElementById('mainHeader').style.display = '';

  generateTask1();
  generateTask2();

  switchScreen('screenTest');
  testStartTime = new Date();
  startTimer();
}

// ═══ TIMER ═══
function startTimer() {
  updateTimerDisplay();
  timerInterval = setInterval(() => {
    secondsLeft--;
    updateTimerDisplay();
    updateProgress();
    if (secondsLeft <= 0) { clearInterval(timerInterval); autoSubmit(); }
  }, 1000);
}
function updateTimerDisplay() {
  const m = String(Math.floor(secondsLeft / 60)).padStart(2, '0');
  const s = String(secondsLeft % 60).padStart(2, '0');
  document.getElementById('timerVal').textContent = m + ':' + s;
  const el = document.getElementById('timer');
  el.classList.toggle('danger', secondsLeft < 120);
}
function updateProgress() {
  const pct = ((TOTAL_SECONDS - secondsLeft) / TOTAL_SECONDS) * 100;
  document.getElementById('progressFill').style.width = pct + '%';
}

// ═══ TASK NAVIGATION ═══
function showTask(n) {
  document.getElementById('task1block').style.display = n === 1 ? '' : 'none';
  document.getElementById('task2block').style.display = n === 2 ? '' : 'none';
  document.getElementById('tab1').className = 'nav-tab' + (n===1?' active':'');
  document.getElementById('tab2').className = 'nav-tab' + (n===2?' active':'');
}

// ═══════════════════════════════════
// TASK 1 GENERATION
// ═══════════════════════════════════
function generateTask1() {
  // 6 unique integer x values between 1..20
  const xs = [];
  while (xs.length < 6) {
    const v = Math.floor(Math.random() * 18) + 1;
    if (!xs.includes(v)) xs.push(v);
  }
  xs.sort((a, b) => a - b);

  // 6 frequency y values (decimal, 1 decimal place, sum reasonable)
  const ys = [];
  for (let i = 0; i < 6; i++) {
    ys.push(Math.round((Math.random() * 0.25 + 0.05) * 10) / 10);
  }

  t1x = xs; t1y = ys;

  // compute mean: sum(x*y)/sum(y)
  let sumW = 0, sumXW = 0;
  for (let i = 0; i < 6; i++) { sumW += ys[i]; sumXW += xs[i] * ys[i]; }
  t1mean = Math.round((sumXW / sumW) * 100) / 100;

  // compute median from weighted distribution
  // expand: for each x[i], weight y[i] (treat as proportion → multiply by 100 for integer counts)
  const expanded = [];
  ys.forEach((y, i) => {
    const cnt = Math.round(y * 20);
    for (let j = 0; j < cnt; j++) expanded.push(xs[i]);
  });
  expanded.sort((a, b) => a - b);
  const mid = Math.floor(expanded.length / 2);
  t1median = expanded.length % 2 === 0
    ? Math.round(((expanded[mid - 1] + expanded[mid]) / 2) * 100) / 100
    : expanded[mid];

  // render table
  let html = '<thead><tr><th>x</th>';
  xs.forEach(x => html += `<th>${x}</th>`);
  html += '</tr><tr><th>y</th>';
  ys.forEach(y => html += `<td>${y.toFixed(1)}</td>`);
  html += '</tr></thead>';
  document.getElementById('dataTable1').innerHTML = html;

  // render chart
  if (chart1Instance) chart1Instance.destroy();
  chart1Instance = new Chart(document.getElementById('chart1'), {
    type: 'bar',
    data: {
      labels: xs.map(String),
      datasets: [{
        label: 'Частота y',
        data: ys,
        backgroundColor: xs.map((_, i) => `hsla(${210 + i*25},70%,60%,0.8)`),
        borderColor: xs.map((_, i) => `hsla(${210 + i*25},70%,50%,1)`),
        borderWidth: 1.5, borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#e8eaf6', font: { family: 'Golos Text' } } } },
      scales: {
        x: { ticks: { color: '#7a7f9a' }, grid: { color: '#2a2f50' } },
        y: { ticks: { color: '#7a7f9a' }, grid: { color: '#2a2f50' }, beginAtZero: true }
      }
    }
  });
}

// ═══════════════════════════════════
// TASK 2 GENERATION
// ═══════════════════════════════════
function generateTask2() {
  // 30 random values in range 10..90
  t2data = Array.from({ length: 30 }, () => Math.floor(Math.random() * 81) + 10);
  t2data.sort((a, b) => a - b);

  const min = t2data[0], max = t2data[t2data.length - 1];
  const step = Math.ceil((max - min + 1) / 6);

  // build intervals
  t2intervals = [];
  t2counts = [];
  for (let i = 0; i < 6; i++) {
    const lo = min + i * step;
    const hi = min + (i + 1) * step;
    t2intervals.push([lo, hi]);
    t2counts.push(t2data.filter(v => v >= lo && (i === 5 ? v <= hi : v < hi)).length);
  }

  // show data chips
  const chips = document.getElementById('dataChips2');
  chips.innerHTML = t2data.map(v => `<span class="chip">${v}</span>`).join('');

  // sliders — student sets each bar
  t2sliderVals = new Array(6).fill(0);
  const ss = document.getElementById('sliderSection');
  ss.innerHTML = '';
  t2intervals.forEach((interval, i) => {
    const row = document.createElement('div');
    row.className = 'slider-row';
    row.innerHTML = `
      <span class="slider-label">[${interval[0]}–${interval[1]})</span>
      <input type="range" min="0" max="15" value="0" id="sl${i}" oninput="onSlider(${i},this.value)">
      <span class="slider-val" id="slv${i}">0</span>
    `;
    ss.appendChild(row);
  });

  renderChart2();
}

function onSlider(i, v) {
  t2sliderVals[i] = parseInt(v);
  document.getElementById('slv' + i).textContent = v;
  renderChart2();
}

function renderChart2() {
  const labels = t2intervals.map(iv => `${iv[0]}–${iv[1]}`);
  if (chart2Instance) chart2Instance.destroy();
  chart2Instance = new Chart(document.getElementById('chart2'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Частота (ваш ответ)',
        data: t2sliderVals,
        backgroundColor: labels.map((_, i) => `hsla(${160 + i*20},60%,55%,0.8)`),
        borderColor: labels.map((_, i) => `hsla(${160 + i*20},60%,45%,1)`),
        borderWidth: 1.5, borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#e8eaf6', font: { family: 'Golos Text' } } } },
      scales: {
        x: { ticks: { color: '#7a7f9a' }, grid: { color: '#2a2f50' } },
        y: { ticks: { color: '#7a7f9a' }, grid: { color: '#2a2f50' }, beginAtZero: true, max: 15 }
      }
    }
  });
}

// ═══════════════════════════════════
// SCORING
// ═══════════════════════════════════
function scoreTask1() {
  const rawMean = parseFloat(document.getElementById('ans1mean').value);
  const rawMed = parseFloat(document.getElementById('ans1med').value);
  const okMean = !isNaN(rawMean) && Math.abs(rawMean - t1mean) < 0.15;
  const okMed = !isNaN(rawMed) && Math.abs(rawMed - t1median) < 0.6;

  const elM = document.getElementById('ans1mean');
  const elMed = document.getElementById('ans1med');
  elM.className = okMean ? 'correct' : 'wrong';
  elMed.className = okMed ? 'correct' : 'wrong';

  return { mean: okMean ? 1 : 0, med: okMed ? 1 : 0 };
}

function scoreTask2() {
  // compare slider values to actual counts; allow ±1 tolerance per bar
  let correct = 0;
  t2counts.forEach((cnt, i) => {
    if (Math.abs(t2sliderVals[i] - cnt) <= 1) correct++;
  });
  // give 1 point if ≥4 out of 6 bars correct, 2 if all 6
  if (correct === 6) return 2;
  if (correct >= 4) return 1;
  return 0;
}

// ═══════════════════════════════════
// SUBMIT
// ═══════════════════════════════════
function submitTest() {
  if (!confirm('Завершить работу и сдать ответы?')) return;
  finalize();
}
function autoSubmit() {
  alert('Время вышло! Работа сдаётся автоматически.');
  finalize();
}

function finalize() {
  clearInterval(timerInterval);
  const s1 = scoreTask1();
  const s2 = scoreTask2();
  const total = s1.mean + s1.med + s2;

  const elapsed = Math.round((new Date() - testStartTime) / 1000);
  const mins = Math.floor(elapsed / 60), secs = elapsed % 60;
  const timeStr = `${mins}м ${secs}с`;

  // show results
  document.getElementById('scoreNum').textContent = total;
  const msgs = ['Работа принята. Нужно повторить материал.', 'Хороший результат! Есть над чем поработать.', 'Отлично справились!', 'Великолепный результат!', 'Блестящая работа!'];
  document.getElementById('resultMsg').textContent = msgs[Math.min(total, 4)];

  document.getElementById('resultTable').innerHTML = `
    <tr><td>Ученик</td><td>${studentName}</td></tr>
    <tr><td>Задание 1 — среднее</td><td>${s1.mean ? '✓ верно' : `✗ ответ: ${parseFloat(document.getElementById('ans1mean').value)||'—'} | правильно: ${t1mean}`}</td></tr>
    <tr><td>Задание 1 — медиана</td><td>${s1.med ? '✓ верно' : `✗ ответ: ${parseFloat(document.getElementById('ans1med').value)||'—'} | правильно: ${t1median}`}</td></tr>
    <tr><td>Задание 2 — гистограмма</td><td>${s2 === 2 ? '✓✓ полный балл' : s2 === 1 ? '✓ частично верно' : '✗ неверно'}</td></tr>
    <tr><td>Нарушений</td><td>${violationCount}</td></tr>
    <tr><td>Время</td><td>${timeStr}</td></tr>
    <tr><td><strong>Итого</strong></td><td><strong>${total} / 4</strong></td></tr>
  `;

  switchScreen('screenResult');
  document.getElementById('mainHeader').style.display = 'none';

  sendToSheets({ studentName, total, s1mean: s1.mean, s1med: s1.med, s2, violationCount, timeStr,
    ans1mean: document.getElementById('ans1mean').value, ans1med: document.getElementById('ans1med').value,
    correctMean: t1mean, correctMedian: t1median,
    sliderAnswers: t2sliderVals.join(','), correctCounts: t2counts.join(',') });
}

// ═══════════════════════════════════
// GOOGLE SHEETS
// ═══════════════════════════════════
function sendToSheets(data) {
  if (APPS_SCRIPT_URL.includes('YOUR_SCRIPT_ID')) return; // not configured
  fetch(APPS_SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ...data, timestamp: new Date().toISOString() })
  }).catch(() => {});
}

// ═══ UTILS ═══
function switchScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

<!--
═══════════════════════════════════════════════════════════════════
GOOGLE APPS SCRIPT — вставьте в редактор Google Apps Script:
═══════════════════════════════════════════════════════════════════

function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);

  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      'Время', 'Ученик', 'Итого', 'Среднее(зад1)', 'Медиана(зад1)',
      'Гистограмма(зад2)', 'Нарушений', 'Затрачено',
      'Ответ среднее', 'Правильное среднее',
      'Ответ медиана', 'Правильная медиана',
      'Ответы ползунков', 'Правильные счётчики'
    ]);
  }

  sheet.appendRow([
    data.timestamp, data.studentName, data.total,
    data.s1mean, data.s1med, data.s2, data.violationCount, data.timeStr,
    data.ans1mean, data.correctMean,
    data.ans1med, data.correctMedian,
    data.sliderAnswers, data.correctCounts
  ]);

  return ContentService.createTextOutput('ok');
}

После публикации: Расширения → Apps Script → Развернуть → Веб-приложение
Скопируйте URL и вставьте в APPS_SCRIPT_URL выше.
═══════════════════════════════════════════════════════════════════
-->
</body>
</html>
